<!doctype html>

<meta charset="utf-8">
<title>Physical graph {{pg_name}}</title>

<script src="/static/d3/d3.v3.min.js" charset="utf-8"></script>
<script src="/static/d3/dagre-d3.min.js"></script>

<style>

  body {
    position: fixed;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    margin: 0;
    padding: 0;
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serf;
    background: #fff;
  }


  @-webkit-keyframes flash {
    0%, 50%, 100% {
      opacity: 1;
    }

    25%, 75% {
      opacity: 0.2;
    }
  }

  @keyframes flash {
    0%, 50%, 100% {
      opacity: 1;
    }

    25%, 75% {
      opacity: 0.2;
    }
  }

  .warn {
    -webkit-animation-duration: 5s;
    animation-duration: 5s;
    -webkit-animation-fill-mode: both;
    animation-fill-mode: both;
    -webkit-animation-iteration-count: 1;
    animation-iteration-count: 1;
  }

  .live.map {
    width: 100%;
    height: 100%;
  }

  svg {
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  .live.map text {
    font-weight: 200;
    font-size: 10px;
  }

  .live.map .node rect {
    stroke-width: 2.0px;
    stroke: #bbb;
    fill: #fff;
  }

  .live.map .status {
    height: 100%;
    width: 30px;
    display: block;
    float: left;
    border-top-left-radius: 5px;
    border-bottom-left-radius: 5px;
    margin-right: 4px;
  }

  .live.map .allocated .status {
    background-color: #7f7;
  }

  .live.map .container .status {
    background-color: #ffed68;
  }

  .live.map .allocated.warn .status {
    background-color: #ffed68;
  }

  .live.map .stopped .status {
    background-color: #700000;
  }

  .live.map .warn .queue {
    color: #f77;
  }

  .warn {
    -webkit-animation-name: flash;
    animation-name: flash;
  }

  .live.map .loc {
    margin-right: 2px;
  }

  .live.map .loc,
  .live.map .name {
    margin-top: 4px;
  }

  .live.map .loc:after {
    content: "";
  }

  .live.map .queue {
    display: block;
    float: left;
    width: 130px;
    height: 20px;
    font-size: 10px;
    margin-top: 2px;
  }

  .live.map .node g div {
    width: 180px;
    height: 40px;
    color: #000;
  }

  .live.map .node g div span.loc {
    display: inline-block;
    width: 20px;
  }

  .live.map .edgeLabel text {
    width: 50px;
    fill: #fff;
  }

  .live.map .edgePath path {
    stroke: #999;
    stroke-width: 1.5px;
    fill: #999;
  }
</style>

<body>
<div>
	<a href="/">All graphs</a>
	<a href="jsonbody?pg_name={{pg_name}}">See JSON body</a>
	<a href="execute?pg_name={{pg_name}}">Execute with Luigi</a>
</div>
<div class="live map">
  <svg><g/></svg>
</div>

<script>
  /*
  var xmlhttp = new XMLHttpRequest();
  var url = "http://localhost:8081/jsonbody?pg_name=container";
  var workers;
  xmlhttp.onreadystatechange = function() {
    if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
        workers = JSON.parse(xmlhttp.responseText);
        //get_worker(myArr);
    }
  }

  xmlhttp.open("GET", url, true);
  xmlhttp.send();
  */
  //var workers = {"Obj-D": {"loc": "192.168.1.2:7777", "inputQueue": [{"oid": "Obj-C"}], "type": 1}, "Obj-one": {"loc": "192.168.1.1:7777", "type": 4}, "Obj-A": {"loc": "192.168.1.1:7777", "inputQueue": [{"oid": "Obj-one"}], "type": 4}, "Obj-C": {"loc": "192.168.1.2:7777", "inputQueue": [{"oid": "Obj-A"}, {"oid": "Obj-B"}], "type": 2}, "Obj-B": {"loc": "192.168.1.1:7777", "inputQueue": [{"oid": "Obj-one"}], "type": 4}};
  var workers = {{!json_workers}}
  /*
  var workers = {
    "identifier": {
      "loc": 2,
      "type": 20
    },
    "lost-and-found": {
      "loc": 1,
      "type": 1,
      "inputQueue": "identifier",
      "inputThroughput": 50
    },
    "monitor": {
      "loc": 1,
      "type": 0,
      "inputQueue": "identifier",
      "inputThroughput": 50
    },
    "meta-enricher": {
      "loc": 4,
      "type": 9900,
      "inputQueue": "identifier",
      "inputThroughput": 50
    },
    "geo-enricher": {
      "loc": 2,
      "type": 1,
      "inputQueue": "meta-enricher",
      "inputThroughput": 50
    },
    "elasticsearch-writer": {
      "loc": 0,
      "type": 9900,
      "inputQueue": "geo-enricher",
      "inputThroughput": 50
    }
  }; */

  // Set up zoom support
  var svg = d3.select("svg"),
      inner = svg.select("g"),
      zoom = d3.behavior.zoom().on("zoom", function() {
        inner.attr("transform", "translate(" + d3.event.translate + ")" +
                                    "scale(" + d3.event.scale + ")");
      });
  svg.call(zoom);

  var render = new dagreD3.render();

  // Left-to-right layout
  var g = new dagreD3.graphlib.Graph();
  g.setGraph({
    nodesep: 70,
    ranksep: 50,
    rankdir: "LR",
    marginx: 20,
    marginy: 20
  });

  function draw(isUpdate) {
    for (var id in workers) {
      var worker = workers[id];
      var className;
      switch(worker.type) {
        case 3:
          className = 'warn'
          break
        case 2:
          className = "container";
          break;
        case 1:
          className = "stopped";
          break;
        default:
          className = "allocated"
      }
      /*
      var className = worker.loc ? "allocated" : "stopped";
      if (worker.type > 10000) {
        className += " warn";
      }
      */
      var html = "<div>";
      html += "<span class=status></span>";
      html += "<span class=name>" + id + "</span>";
      html += "<br/>"
      html += "<span class=name>" + "@" + worker.loc + "</span>";
      //html += "<span class=name>" + id + "</span>";
      //html += "<span class=queue><span class=counter>"+worker.type+"</span></span>";
      html += "</div>";
      g.setNode(id, {
        labelType: "html",
        label: html,
        rx: 5,
        ry: 5,
        padding: 0,
        class: className
      });

      if (worker.inputQueue) {
        var i;
        for (i = 0; i < worker.inputQueue.length; i++) {
            g.setEdge(worker.inputQueue[i].oid, id, {
            label: "",
            width: 40
          });
        }

      }
    }

    inner.call(render, g);

    // Zoom and scale to fit
    var zoomScale = zoom.scale();
    var graphWidth = g.graph().width + 80;
    var graphHeight = g.graph().height + 40;
    var width = parseInt(svg.style("width").replace(/px/, ""));
    var height = parseInt(svg.style("height").replace(/px/, ""));
    zoomScale = Math.min(width / graphWidth, height / graphHeight);
    var translate = [(width/2) - ((graphWidth*zoomScale)/2), (height/2) - ((graphHeight*zoomScale)/2)];
    zoom.translate(translate);
    zoom.scale(zoomScale);
    zoom.event(isUpdate ? svg.transition().duration(500) : d3.select("svg"));
  }

  // Do some mock queue status updates
  /*
  setInterval(function() {
    var stoppedWorker1Count = workers["elasticsearch-writer"].type;
    var stoppedWorker2Count = workers["meta-enricher"].type;
    for (var id in workers) {
      workers[id].type = Math.ceil(Math.random() * 3);
      if (workers[id].inputThroughput) workers[id].inputThroughput = Math.ceil(Math.random() * 250);
    }
    workers["elasticsearch-writer"].type = stoppedWorker1type + Math.ceil(Math.random() * 100);
    workers["meta-enricher"].type = stoppedWorker2Count + Math.ceil(Math.random() * 100);
    draw(true);
  }, 1000);

  // Do a mock change of worker configuration
  setInterval(function() {
    workers["elasticsearch-monitor"] = {
      "loc": 0,
      "type": 0,
      "inputQueue": "elasticsearch-writer",
      "inputThroughput": 50
    }
  }, 5000);
  */

  draw();
</script>
