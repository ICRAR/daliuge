<html lang="en">
<head>
<title>Translator</title>
 <!-- Required bootstrap meta tags -->
 <meta charset="utf-8">
 <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
 <meta name="viewport" content="width=device-width, maximum-scale=1.0">
 <link rel="shortcut icon" type="image/jpg" href="/static/src/icons/liuFavIcon.svg"/>

 <script src="/static/src/d3/d3.v5.min.js"></script>
 <script src="/static/src/d3/dagre-d3.min.js"></script>
 <script src="/static/src/jquery.min.js"></script>
 <script src="/static/src/bootstrap/js/bootstrap.bundle.min.js"></script>
 <script src="/static/src/html2canvas.min.js"></script>
 <script src="/static/src/FileSaver.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.2.2/echarts.min.js"></script>
 <script src="/static/src/echarts-dagre.min.js"></script>
 <script src="/static/src/lib/fflate/index.js"></script>
 <script src="/static/src/require.js"></script>
 <script src="/static/main.js"></script>

 <!-- CSS -->
<link rel="stylesheet" href="/static/src/bootstrap/css/bootstrap.min.css">
<link type="text/css" rel="stylesheet" href="/static/src/main.css" />

<!-- Global Variables -->
<script>
    var pgtName = "{{pgt_view_json_name}}"
</script>
</head>

<body>


    <!-- custom bootstrap navbar -->
    <nav class="navbar fixed-top navbar-expand-lg navbar-dark" style="background-color: #004085;">
            <!-- Navbar content -->
            <a href="javascript:void(0)" class="navbar-brand inactiveLink" href="#" disabled>
                <object data="/static/src/icons/liu.svg" type="image/svg+xml" width="30" height="30" class="d-inline-block align-top" alt="LiuIcon"></object>
			    <img src="/static/src/icons/translate_green.png" width="30" height="30" class="d-inline-block align-top" alt="">
                <span> Translator </span>
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="nav navbar-nav navbar-center">
                    <!--    zoom not supported for this type of echart, buttons removed for now
                        <li class="nav-item">
                        <a href="javascript:void(0)" href="javascript:void(0)" class="nav-link tooltip" id="zoom_button" onclick="zoomToFit()"><img src="/static/src/icons/zoom_out_map_white_24dp.svg" alt="Zoom To Fit">
                            <span class="tooltiptext">Zoom To Fit</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="javascript:void(0)" onclick="zoomOut()" class="nav-link tooltip"><img src="/static/src/icons/zoom_out_white_24dp.svg" alt="Zoom Out">
                            <span class="tooltiptext">Zoom Out</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="javascript:void(0)" onclick="zoomIn()" class="nav-link tooltip"><img src="/static/src/icons/zoom_in_white_24dp.svg" alt="Zoom In">
                            <span class="tooltiptext">Zoom In</span>
                        </a>
                    </li> -->

                    <!-- unfinished, not needed until we change graph renderer -->
                    <!-- <li class="nav-item dropdown">
                        <a href="javascript:void(0)" class="nav-link tooltip" id="GraphOrientationDropdownBtn" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <img src="/static/src/icons/explore_white_24dp.svg" alt="Graph Orientation">
                            <span class="tooltiptext">Graph Orientation</span>
                        </a>
                        <div id="oriantationDropdown" class="dropdown-menu dropdown-menu-right" aria-labelledby="GraphOrientationDropdown">
                            <div class="orientationOptionContainer"><input type="radio" name="direction" onclick="layout()" value="0" checked="checked" /><a href="javascript:void(0)" class="inactiveLink nav-link">Right (0)</a></div>
                            <div class="orientationOptionContainer"><input type="radio" name="direction" onclick="layout()" value="90" /><a href="javascript:void(0)" class="inactiveLink nav-link">Down (90)</a></div>
                            <div class="orientationOptionContainer"><input type="radio" name="direction" onclick="layout()" value="180" /><a href="javascript:void(0)" class="inactiveLink nav-link">Left (180)</a></div>
                            <div class="orientationOptionContainer"><input type="radio" name="direction" onclick="layout()" value="270" /><a href="javascript:void(0)" class="inactiveLink nav-link">Up (270)</a></div>
                        </div>
                    </li> -->
                    <div class="btn-group" role="group" id="view-mode-buttons">
                        <button type="button" id="graphButton" value="graph" class="btn btn-secondary tooltip tooltipBottom graphChanger" data-text="Better For Small Graphs" >Dagre</button>
                        <button type="button" id="sankeyButton" value="sankey" class="btn btn-secondary tooltip tooltipBottom graphChanger" data-text="Better For Big Graph" >Sankey</button>
                   </div>
                </ul>
                <ul class="nav navbar-nav  ml-auto">
                    <li class="nav-item">
                        <a href="javascript:void(0)" class="nav-link tooltip tooltipBottom" data-text="Deploy Physical Graph via HELM" id="helm_deploy_button" value="Deploy Physical Graph via HELM">HELM Deploy</a>
                    </li>
                    <li class="nav-item">
                        <a href="javascript:void(0)" class="nav-link tooltip tooltipBottom" data-text="Deploy Physical Graph via REST" id="rest_deploy_button" value="Deploy Physical Graph via REST">REST Deploy</a>
                    </li>
                    <li class="nav-item">
                        <a href="javascript:void(0)" class="nav-link tooltip tooltipBottom" data-text="Generate and deploy physical graph" id="deploy_button" value="Generate &amp; Deploy Physical Graph">Deploy</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a href="javascript:void(0)" class="nav-link dropdown-toggle" id="navbarExportDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Export
                        </a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarExportDropdown">
                            <span id="exportJsonBtn" class="dropdown-item dropDropDownParent" href="#">JSON <img id="exportJsonIcon" src="/static/src/icons/arrow_right_white_24dp.svg" alt="">
                                <div class="dropDropDown">
                                    <a id="json_button" class="dropdown-item" onclick="makeJSON()">Physical Graph Template</a>
                                    <a id="Pysical_graph" class="dropdown-item" href="#">Physical Graph</a>
                                </div>
                            </span>
                            <div class="dropdown-divider"></div>
                            <a href="javascript:void(0)" id="png_button" class="dropdown-item" onclick="makePNG()">Screenshot</a>
                        </div>
                    </li>
                    <li class="nav-item">
                        <a href="javascript:void(0)" class="nav-link tooltip tooltipBottomLeft" data-text="Settings" data-toggle="modal" data-target="#settingsModal"><img src="/static/src/icons/settings_white_24dp.svg" alt="Settings"></a>
                    </li>
                </ul>
            </div>
    </nav>
    <div id="graphNameWrapper">
            <span id="graphName">{{pgt_view_json_name}}</span>
    </div>
    <div id="main"></div>
    <div id="SVGArea"></div>
    <div id="runinfoWrapper">
        <span id="runinfo" >{{partition_info}}</span>
    </div>

    <div onload="init();" class="modal fade" id="settingsModal" tabindex="-1" role="dialog" aria-labelledby="settingsModalLabel" aria-hidden="true">
       <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingsModalLabel">Settings</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form action="/gen_pg" method="get" id="pg_form" target="_blank">
                        <div class="settingsSection">
                            <span>DALiuGE Manager URL:</span>
                            <input id="managerUrlInput" type="text" name="dlg_mgr_url" value="http://localhost:8001" size="40" style="font-size:16px;">
                        </div>
                        <input type="checkbox" id="dlg_mgr_deploy" style="visibility:hidden;" name="dlg_mgr_deploy" value="deploy" checked>
                        <input type="hidden" name="pgt_id" value="{{pgt_view_json_name}}">
                      </form>
                    <form action="/gen_pg_helm" method="get" id="pg_helm_form" target="_blank">
                        <input type="checkbox" id="dlg_helm_deploy" style="visibility:hidden;" name="dlg_helm_deploy" value="helm_deploy" checked>
                        <input type="hidden" name="pgt_id" value="{{pgt_view_json_name}}">
                    </form>
                </div>
                <div class="modal-footer">
                    <button onClick="" type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button onClick="saveSettings()" type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- init script includes require, this links main js and echarts -->
    <script src="/static/graph_init.js"></script>
    <script>
    view_as_graph()
    function view_as_graph() {

        
        const heightValue = 300;
        const widthValue = 600;
        // Set up zoom support

        d3.select("#SVGArea").append("svg").attr("id", "smallD3Graph").append("g").attr("id","root")
	    var svg = d3.select("#smallD3Graph")
        // svgGroup = svg.append("g");
        var inner = svg.select("g");

        // svg.call(d3.zoom().on("zoom", function () {
        // 	inner.attr("transform", "translate(" + d3.event.translate + ")"
        // 			+ "scale(" + d3.event.scale + ")");
        // }))

        var zoom = d3.zoom().on("zoom", function () {//Add mouse wheel zoom event
        inner.attr("transform", d3.event.transform);
        });
        svg.call(zoom);

        var g = new dagreD3.graphlib.Graph({compound:true})
        .setGraph({
            nodesep : 70,
            ranksep : 50,
            rankdir : "LR", // Left-to-right layout
            marginx : 20,
            marginy : 20
        })
        .setDefaultEdgeLabel(function () { return {}; });

        var render = getRender();
        function drawGraph() {
            console.log("rendering")
            inner.call(render, g);
            // render(inner,g)
        }

        //zoom WIP
        // var initialScale = 0.30;
        // root.call(zoom.transform, d3.zoomIdentity.translate((fullWidth - width * initialScale) / 2, 20).scale(initialScale));

        // svg.attr('height', g.graph().height * initialScale + 40);

        var orientButtons = d3.selectAll('#graph-orientation-buttons button');
            orientButtons.on('click', function() {
            direction = d3.event.currentTarget.value;
            orientButtons.attr("disabled", "disabled");
            orientButtons.filter("[value=" + direction + "]").classed("active", true);
            orientButtons.filter(":not([value=" + direction + "])").classed("active", false);
            g.graph().rankdir = direction;
            drawGraph();
            orientButtons.attr("disabled", null);
            status_update_handler()
        });

        // This works assuming that the status list comes in the same order
        // that the graph was created, which is true
        // Anyway, we could double-check in the future
        var delay = 1000;
        var graph_update_handler = drawGraphForDrops.bind(null, g, drawGraph);
        var status_update_handler = function(statuses) {
            d3.selectAll('g.nodes').selectAll('g.node')
            .data(statuses).attr("class", function(s) {
                return "node " + get_status_name(s);
            });
        };

        $.ajax({
            //get data
            url: "/pgt_jsonbody?pgt_name="+pgtName,
            dataType: "json",
            type: 'get',
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                if (404 == XMLHttpRequest.status) {
                alert('Server cannot locate physical graph file ' + pgtName.toString())
                } else {
                alert('status:' + XMLHttpRequest.status + ', status text: ' + XMLHttpRequest.statusText);
                }
            },
            success: function(data){
                console.log(data)
                graph_update_handler(data)
            }
        });


        // startStatusQuery(serverUrl, sessionId, selectedNode, graph_update_handler,
        //                 status_update_handler, 1000);	
    }

    function zoomFit() {

        // Center the graph
        var zoom = d3.zoom().on("zoom", function () {//Add mouse wheel zoom event
            inner.attr("transform", d3.event.transform);
        });
        var svg = d3.select('#smallD3Graph')
        ;

        var root = svg.select('#root');
        var boot = $(".output");
        var bounds = root.node().getBBox();
        var parent = root.node().parentElement;
        var fullWidth = parent.clientWidth,
            fullHeight = parent.clientHeight;
        var width = bounds.width,
            height = bounds.height,
            initialScale;
        var widthScale = ((fullWidth-80)/width);
        var heightScale = ((fullHeight-200)/height)
        if (heightScale<widthScale){
            initialScale = heightScale;
        } else {
            initialScale = widthScale;
        };
        initialScale = initialScale
        var xCenterOffset = -(fullWidth - fullWidth) / 2;
        boot.attr("transform", "translate(" + (fullWidth-(width*initialScale))/2 + ", " + ((fullHeight-80)-(height*initialScale))/2 + ")"+' scale('+initialScale+')');
    }

    </script>
</body>
</html>
