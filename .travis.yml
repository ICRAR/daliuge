#
# Travis CI configuration file
#
# ICRAR - International Centre for Radio Astronomy Research
# (c) UWA - The University of Western Australia, 2016
# Copyright by UWA (in the framework of the ICRAR)
# All rights reserved
#
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Lesser General Public
# License as published by the Free Software Foundation; either
# version 2.1 of the License, or (at your option) any later version.
#
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public
# License along with this library; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston,
# MA 02111-1307  USA
#

# To use docker later...
sudo: required

# let's go!
language: python
matrix:
  include:
    - python: "3.8"
      env: NO_DLG_RUNTIME=1
    - python: "3.8"
      env: NO_DLG_TRANSLATOR=1
    - python: "3.8"
      env: TEST_OPENAPI=1
    - python: "3.7"
    - python: "3.6"
    - python: "3.5"
    - python: "2.7"

# We want to use docker during the tests
services:
 - docker

# Try to speed up builds by caching our dependencies
cache: pip

before_install:
 - pip install -U coveralls pytest pytest-cov
 - pip install -U setuptools pip wheel

install:
 - pip install -e daliuge-common/
 - test -n "$NO_DLG_TRANSLATOR" || pip install -e daliuge-translator/
 - test -n "$NO_DLG_RUNTIME" || pip install -e daliuge-runtime/

before_script:
 - sudo apt-get update && sudo apt-get install -y doxygen && sudo apt-get install -y xsltproc
   #if: branch = doxygentest@ICRAR/daliuge
   #branches:
   #only:
   #- doxygentest
on:
  push:
    branches:
      - doxygentest@ICRAR/daliuge

# run the tests, making sure subprocesses generate coverage information
script:
 - COVFILES=
 - test -n "$NO_DLG_TRANSLATOR" || { (cd daliuge-translator && py.test --cov) && COVFILES+=" daliuge-translator/.coverage"; }
 - test -n "$NO_DLG_RUNTIME" || { (cd daliuge-runtime && py.test --cov) && COVFILES+=" daliuge-runtime/.coverage"; }
 - coverage combine $COVFILES
 - test -z "$TEST_OPENAPI" || (cd OpenAPI/tests && ./test_managers_openapi.sh)

after_script:
        #branches:
        #only:
        #- doxygentest
  if: branch = doxygentest@ICRAR/daliuge

 - GIT_REPO=$(git remote -v) PROJECT_VERSION=$(git rev-parse --short HEAD) doxygen
 - cd DALIUGE/xml
 - xsltproc combine.xslt index.xml >daliuge.xml
 - mv daliuge.xml ../.
 - cd ..
 - rm -rf xml/
 - cd ..
 - git config --global user.name $GITHUB_USERNAME
 - git config --global user.email "$GITHUB_USERNAME@gmail.com"
 - git clone https://$GITHUB_TOKEN@github.com/ICRAR/EAGLE_test_repo
 - cd EAGLE_test_repo/
 - git checkout origin/doxygentest
 - rm -rf DALIUGE/
 - mv ../DALIUGE/ .
 - git checkout -b doxygentest
 - git add * 
 - git diff-index --quiet HEAD || git commit -m 'doxygen test'
 - git push -u origin doxygentest

# Publish to coveralls (only once per commit, so only using one environment)
after_success:
 - coveralls
